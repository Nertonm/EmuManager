============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/nerton/TRABALHO/Projects/EmuManager
configfile: pyproject.toml
testpaths: tests
collected 301 items / 6 skipped

tests/test_advanced_deduplication.py ...............                     [  4%]
tests/test_analytics_dashboard.py ......................                 [ 12%]
tests/test_common_system.py ...                                          [ 13%]
tests/test_compress_rm.py ....                                           [ 14%]
tests/test_compression.py ........                                       [ 17%]
tests/test_compression_profile.py ..                                     [ 17%]
tests/test_controllers_duplicates.py ....                                [ 19%]
tests/test_controllers_tools.py .......                                  [ 21%]
tests/test_core_dat_manager.py ...                                       [ 22%]
tests/test_core_integrity.py .....                                       [ 24%]
tests/test_core_scanner.py ......                                        [ 26%]
tests/test_dat_downloader.py ...                                         [ 27%]
tests/test_dat_parser.py .....                                           [ 28%]
tests/test_dolphin_converter.py ........                                 [ 31%]
tests/test_duplicates.py ...                                             [ 32%]
tests/test_duplicates_move.py ...                                        [ 33%]
tests/test_exceptions.py .............                                   [ 37%]
tests/test_execution.py ....                                             [ 39%]
tests/test_execution_additional.py .....                                 [ 40%]
tests/test_execution_quickwins.py ...                                    [ 41%]
tests/test_fileops.py ........                                           [ 44%]
tests/test_formatting.py ......                                          [ 46%]
tests/test_gamecube_metadata.py ....                                     [ 47%]
tests/test_gamecube_provider.py ...                                      [ 48%]
tests/test_gui_logic.py ....                                             [ 50%]
tests/test_hasher.py ..                                                  [ 50%]
tests/test_integration_main.py ..                                        [ 51%]
tests/test_main_helpers.py ....                                          [ 52%]
tests/test_meta_extractor.py ...                                         [ 53%]
tests/test_meta_parser.py ...                                            [ 54%]
tests/test_n3ds_converter.py .....                                       [ 56%]
tests/test_n3ds_provider.py ...                                          [ 57%]
tests/test_nsz.py .....                                                  [ 59%]
tests/test_orchestrator_core.py ..                                       [ 59%]
tests/test_process_one_file.py ..                                        [ 60%]
tests/test_ps2_helpers.py ....                                           [ 61%]
tests/test_ps2_metadata.py ......                                        [ 63%]
tests/test_ps2_strip.py .                                                [ 64%]
tests/test_ps3_metadata.py .....                                         [ 65%]
tests/test_psp_provider.py ...                                           [ 66%]
tests/test_psx_metadata.py .....                                         [ 68%]
tests/test_quality_control.py ...................                        [ 74%]
tests/test_recompress.py ...                                             [ 75%]
tests/test_recompression_quarantine.py ....                              [ 77%]
tests/test_restored_features.py ....                                     [ 78%]
tests/test_switch_metadata.py .....                                      [ 80%]
tests/test_switch_provider.py F..                                        [ 81%]
tests/test_utils.py .........                                            [ 84%]
tests/test_validation.py ............................                    [ 93%]
tests/test_verify.py ......                                              [ 95%]
tests/test_wii_metadata.py ...                                           [ 96%]
tests/test_wii_provider.py ...                                           [ 97%]
tests/test_workers_common.py ........                                    [100%]

=================================== FAILURES ===================================
___________ TestSwitchProvider.test_extract_metadata_categorization ____________

self = <emumanager.switch.provider.SwitchProvider object at 0x7fbe78a6bc50>
path = PosixPath('update.nsp')

    def extract_metadata(self, path: Path) -> dict[str, Any]:
        """Extrai metadados de ficheiro Switch com validação robusta.
    
        Args:
            path: Caminho para o ficheiro Switch
    
        Returns:
            Dicionário com metadados (serial, title, version, category, type)
    
        Raises:
            UnsupportedFormatError: Se extensão não suportada
            FileReadError: Se não conseguir ler o ficheiro
            MetadataExtractionError: Se falhar ao extrair metadados
        """
        # Validar entrada
        try:
>           path = validate_path_exists(path, "Switch ROM path", must_be_file=True)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

emumanager/switch/provider.py:51: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

path = PosixPath('update.nsp'), name = 'Switch ROM path', must_be_file = True
must_be_dir = False

    def validate_path_exists(
        path: Path | str,
        name: str = "path",
        must_be_file: bool = False,
        must_be_dir: bool = False
    ) -> Path:
        """Valida que um caminho existe.
    
        Args:
            path: Caminho a validar
            name: Nome do parâmetro (para mensagens de erro)
            must_be_file: Se True, valida que é um ficheiro
            must_be_dir: Se True, valida que é um diretório
    
        Returns:
            Path validado e resolvido
    
        Raises:
            ValidationError: Se o caminho não existe ou tipo incorreto
        """
        if not path:
            raise ValidationError(f"{name} não pode estar vazio")
    
        p = Path(path).resolve()
    
        if not p.exists():
>           raise FileNotFoundError(str(p))
E           emumanager.common.exceptions.FileNotFoundError: Ficheiro não encontrado: /home/nerton/TRABALHO/Projects/EmuManager/update.nsp (path=/home/nerton/TRABALHO/Projects/EmuManager/update.nsp)

emumanager/common/validation.py:49: FileNotFoundError

The above exception was the direct cause of the following exception:

self = <tests.test_switch_provider.TestSwitchProvider object at 0x7fbe78960cd0>
mock_meta = <MagicMock name='metadata' id='140456042106224'>
provider = <emumanager.switch.provider.SwitchProvider object at 0x7fbe78a6bc50>

    @patch("emumanager.switch.provider.metadata")
    def test_extract_metadata_categorization(self, mock_meta, provider):
        # Case 1: Base Game
        mock_meta.get_metadata_minimal.return_value = {
            "title_id": "0100000000010000",
            "title": "Super Mario Odyssey"
        }
        with patch("emumanager.switch.provider.validate_path_exists") as mock_val:
            mock_val.return_value = Path("game.nsp")
            meta = provider.extract_metadata(Path("game.nsp"))
        assert meta["category"] == "Base Games"
    
        # Case 2: Update
        mock_meta.get_metadata_minimal.return_value = {
            "title_id": "0100000000010800",
            "title": "Super Mario Odyssey"
        }
>       meta = provider.extract_metadata(Path("update.nsp"))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_switch_provider.py:28: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <emumanager.switch.provider.SwitchProvider object at 0x7fbe78a6bc50>
path = PosixPath('update.nsp')

    def extract_metadata(self, path: Path) -> dict[str, Any]:
        """Extrai metadados de ficheiro Switch com validação robusta.
    
        Args:
            path: Caminho para o ficheiro Switch
    
        Returns:
            Dicionário com metadados (serial, title, version, category, type)
    
        Raises:
            UnsupportedFormatError: Se extensão não suportada
            FileReadError: Se não conseguir ler o ficheiro
            MetadataExtractionError: Se falhar ao extrair metadados
        """
        # Validar entrada
        try:
            path = validate_path_exists(path, "Switch ROM path", must_be_file=True)
            validate_file_extension(path, self.get_supported_extensions())
        except Exception as e:
            if "extensão" in str(e).lower() or "extension" in str(e).lower():
                raise UnsupportedFormatError(self.system_id, path.suffix) from e
>           raise FileReadError(str(path), str(e)) from e
E           emumanager.common.exceptions.FileReadError: Ficheiro não encontrado: /home/nerton/TRABALHO/Projects/EmuManager/update.nsp (path=/home/nerton/TRABALHO/Projects/EmuManager/update.nsp) (path=update.nsp)

emumanager/switch/provider.py:56: FileReadError
=========================== short test summary info ============================
FAILED tests/test_switch_provider.py::TestSwitchProvider::test_extract_metadata_categorization
=================== 1 failed, 300 passed, 6 skipped in 6.31s ===================
